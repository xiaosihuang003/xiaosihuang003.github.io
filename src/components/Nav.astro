---
import { dict, normalizeLang, languages, langMeta } from "../i18n";

interface Props {
  lang?: string;
  /** 当前页的其它语言 URL 映射（详情页会传入） */
  alternates?: Record<string, string>;
}
const { lang: langProp, alternates = {} } = Astro.props as Props;

const pathname = Astro.url?.pathname ?? "/";
const seg = pathname.split("/")[1] || "";
const lang = normalizeLang(langProp || seg);

// 文案 & 前缀
const t = dict[lang];
const base = lang === "en" ? "/en" : `/${lang}`;

// 导航链接
const links = [
  { href: `${base}/`,         label: t.nav.home },
  { href: `${base}/projects`, label: t.nav.projects },
  { href: `${base}/docs`,     label: t.nav.docs }, 
  { href: `${base}/blog`,     label: t.nav.blog },
  { href: `${base}/about`,    label: t.nav.about },
];

// 当前高亮
const normalize = (u: string) => u.replace(/\/+$/, "") || "/";
const isActive = (href: string) => normalize(pathname) === normalize(href);

// 语言跳转：优先使用 alternates；否则“就地替换路径”保留当前 path
const langHref = (code: string) => {
  if (alternates[code]) return alternates[code];
  const rest = pathname.replace(/^\/(?:en|fi|no|sv|zh|yue)(?=\/|$)/, "");
  const prefix = code === "en" ? "/en" : `/${code}`;
  return `${prefix}${rest || "/"}`;
};
---

<header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-zinc-200 dark:bg-zinc-900/80 dark:border-zinc-800">
  <div class="mx-auto max-w-7xl h-16 px-4 md:px-8 flex items-center gap-4">
    <a href={base} class="shrink-0 font-extrabold tracking-tight text-[20px] md:text-[22px]">
      Xiaosi Huang
    </a>

    <div class="hidden sm:block h-5 w-px bg-zinc-200 dark:bg-zinc-800"></div>

    <nav class="hidden sm:flex items-center gap-2 text-[15px] md:text-[16px] font-medium">
      {links.map((l) => (
        <a
          href={l.href}
          aria-current={isActive(l.href) ? "page" : undefined}
          class={(isActive(l.href)
              ? "text-zinc-900 dark:text-zinc-100 bg-zinc-100/80 dark:bg-zinc-800"
              : "text-zinc-600 hover:text-zinc-900 dark:text-zinc-300 dark:hover:text-white hover:bg-zinc-100/60 dark:hover:bg-zinc-800/70"
            ) + " px-3 py-1.5 rounded-lg transition"}
        >
          {l.label}
        </a>
      ))}
    </nav>

    <div class="ml-auto"></div>

    <!-- 语言下拉（桌面） -->
    <details class="relative hidden sm:block">
      <summary class="list-none cursor-pointer select-none rounded-md border border-zinc-300/70 dark:border-zinc-700 px-2 py-1.5 text-[14px] flex items-center gap-1">
        {langMeta[lang].flag} {langMeta[lang].badge}
      </summary>
      <ul class="absolute right-0 mt-2 w-52 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 shadow-lg p-2 space-y-1 z-50">
        {languages.map(code => (
          <li>
            <a href={langHref(code)}
               class="block rounded-md px-3 py-2 hover:bg-zinc-100 dark:hover:bg-zinc-800 flex items-center gap-2">
              <span>{langMeta[code].flag}</span>
              <span>{langMeta[code].label}</span>
            </a>
          </li>
        ))}
      </ul>
    </details>

    <!-- 移动端：合并菜单（语言同样支持就地切换） -->
    <details class="relative sm:hidden">
      <summary class="list-none cursor-pointer select-none rounded-md border border-zinc-300/70 dark:border-zinc-700 px-2 py-1.5 text-[14px]">
        Menu
      </summary>
      <div class="absolute right-0 mt-2 w-56 rounded-xl border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 shadow-lg p-2 z-50">
        <div class="px-2 pb-2 text-[12px] uppercase tracking-wide opacity-60">Navigate</div>
        <nav class="flex flex-col gap-1 mb-2">
          {links.map((l) => (
            <a href={l.href}
               class={(isActive(l.href)
                 ? "bg-zinc-100/80 dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100"
                 : "hover:bg-zinc-100/60 dark:hover:bg-zinc-800/70 text-zinc-700 dark:text-zinc-300"
               ) + " rounded-md px-3 py-2"}>
              {l.label}
            </a>
          ))}
        </nav>
        <div class="px-2 pt-1 pb-2 text-[12px] uppercase tracking-wide opacity-60">Language</div>
        <ul class="space-y-1">
          {languages.map(code => (
            <li>
              <a href={langHref(code)}
                 class="block rounded-md px-3 py-2 hover:bg-zinc-100 dark:hover:bg-zinc-800 flex items-center gap-2">
                <span>{langMeta[code].flag}</span>
                <span>{langMeta[code].label}</span>
              </a>
            </li>
          ))}
        </ul>
      </div>
    </details>
  </div>
</header>

<!-- ✅ 语言切换时带上当前 hash 与滚动比例 -->
<script is:inline>
  function enhanceLangMenus() {
    // 桌面语言菜单
    const desktopLangLinks = document.querySelectorAll('header details:not(.sm\\:hidden) ul a');
    // 移动端语言菜单
    const mobileLangLinks = document.querySelectorAll('header details.sm\\:hidden ul a');
    const links = [...desktopLangLinks, ...mobileLangLinks];

    links.forEach((a) => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const href = e.currentTarget.getAttribute('href');
        if (!href) { return; }
        const url = new URL(href, location.origin);

        // 1) 保留当前小节 hash
        if (location.hash) {
          url.hash = location.hash;
        }

        // 2) 滚动比例兜底
        const doc = document.documentElement, body = document.body;
        const top = doc.scrollTop || body.scrollTop || 0;
        const max = (doc.scrollHeight || body.scrollHeight || 0) - window.innerHeight;
        const ratio = max > 0 ? Math.min(1, Math.max(0, top / max)) : 0;
        url.searchParams.set('pos', ratio.toFixed(4));

        location.href = url.toString();
      }, { passive: false });
    });
  }

  document.addEventListener('astro:page-load', enhanceLangMenus);
  document.addEventListener('DOMContentLoaded', enhanceLangMenus);
</script>
