---
import Layout from "../../../layouts/Layout.astro";
import Breadcrumbs from "../../../components/Breadcrumbs.astro";
import { dict, normalizeLang, languages } from "../../../i18n";
import { getCollection, type CollectionEntry } from "astro:content";

export const prerender = true;

export async function getStaticPaths() {
  const all = await getCollection("blog");
  return all.map((entry: CollectionEntry<"blog">) => {
    const parts = entry.slug.split("/");
    const lang = (parts.at(-1) ?? "en") as string;
    const slug = parts.slice(0, -1).join("/") || parts[0];
    return { params: { lang, slug }, props: { entry, lang, slug } };
  });
}

type PageParams = { lang: string; slug: string };
const { lang: langParam, slug } = Astro.params as PageParams;

const paramsLang = normalizeLang(langParam ?? "en");
const t = dict[paramsLang];
const base = paramsLang === "en" ? "/en" : `/${paramsLang}`;

const { entry } = Astro.props as { entry: CollectionEntry<"blog"> };

const alternates = Object.fromEntries(
  languages.map((code) => [code, `${code === "en" ? "/en" : "/" + code}/blog/${slug}`]),
);

const tags = (entry?.data?.tags ?? []) as string[];
const { Content } = await entry.render();
---

<Layout lang={paramsLang} title={`${entry.data.title} · Xiaosi Huang`} alternates={alternates}>
  <!-- 博客容器你说合适，这里保持 3xl，不动 -->
  <section class="mx-auto max-w-3xl px-4 md:px-6 py-10">
    <div class="post-header">
      <!-- 面包屑 + 返回 同一行 -->
      <div class="crumb-row">
        <Breadcrumbs
          items={[
            { href: base, label: t.nav.home },
            { href: `${base}/blog`, label: t.nav.blog },
          ]}
        />
        <p class="backlink"><a href={`${base}/blog`}>← {t.ui.backToBlog}</a></p>
      </div>

      <!-- 标题区：与 Docs 一致（更小 + 更宽） -->
      <div class="hero-head">
        {entry.data.kicker && <div class="post-kicker">{entry.data.kicker}</div>}
        <h1 class="post-title">{entry.data.title}</h1>
        {entry.data.subtitle && <p class="post-subtitle">{entry.data.subtitle}</p>}

        <div class="post-meta meta-row">
          {entry.data.date && (
            <time datetime={entry.data.date.toISOString?.() ?? String(entry.data.date)}>
              {new Date(entry.data.date).toLocaleDateString(paramsLang)}
            </time>
          )}
          {tags.length > 0 && (
            <div class="tags">
              {tags.map((tag) => <span class="tag">#{tag}</span>)}
            </div>
          )}
        </div>
      </div>
    </div>

    <article class="post-body blog-typo">
      <Content />
    </article>
  </section>
</Layout>

<style>
/* 面包屑 + 返回 同行：右侧对齐 */
.crumb-row{
  display:flex; align-items:center; justify-content:space-between;
  gap:.75rem; margin-bottom:.35rem;
}
@media (max-width:640px){
  .crumb-row{ flex-direction:column; align-items:flex-start; gap:.25rem; }
}
.backlink{ font-size:.9rem; color:var(--muted); white-space:nowrap; }
.backlink a{ text-decoration:none; color:inherit; }
.backlink a:hover{ text-decoration:underline; }

/* 标题区（方案 B）：更小 + 更宽 */
.hero-head{ max-inline-size:110ch; margin:0; }
@media (min-width:1280px){ .hero-head{ max-inline-size:120ch; } }
@media (max-width:900px){ .hero-head{ max-inline-size:90ch; } }
@media (max-width:640px){ .hero-head{ max-inline-size:100%; } }

.post-kicker{ color:var(--muted); font-size:.95rem; margin-bottom:.2rem; }

.post-title{
  margin:.4rem 0 .45rem;
  font-weight:800;
  font-size: clamp(1.2rem, 0.85rem + 0.95vw, 1.55rem); /* ← 与 Docs 同步：更小 */
  line-height:1.14;
  letter-spacing:-.012em;
  text-wrap:balance;
  color:var(--text);
}

.post-subtitle{
  margin:.1rem 0 .65rem;
  color:var(--muted);
  font-weight:400;
  font-size:1rem;
  letter-spacing:.004em;
}

/* Meta（日期/标签）与 Docs 对齐的样式 */
.meta-row{
  display:flex; align-items:center; gap:.8rem; flex-wrap:wrap;
  color:var(--muted); font-size:.9rem;
  padding-bottom:.55rem; margin-bottom:1.2rem;
  border-bottom:1px solid var(--border);
}
.meta-row > * + *::before{
  content:"·"; margin:0 .3rem 0 0; color:var(--muted);
}

/* 标签 chip：与 Docs 一致 */
.tags{ display:inline-flex; gap:.35rem; flex-wrap:wrap; }
.tag{
  font-size:.8rem; font-weight:500; color:var(--muted);
  background:var(--tag-bg); border:1px solid var(--border);
  padding:.22rem .5rem; border-radius:.55rem; line-height:1; letter-spacing:.01em;
}
.tag:hover{ filter:brightness(1.03); }

/* 正文排版（保持你原来的微调） */
.blog-typo{
  --fs-body:1rem; --fs-h2:1.12rem; --fs-h3:1.02rem;
}
.blog-typo p{ font-size:var(--fs-body); line-height:1.85; margin:1rem 0; }
.blog-typo ul, .blog-typo ol{ margin:.9rem 0 .9rem 1.2rem; }
.blog-typo li{ margin:.35rem 0; }
.blog-typo h2{ font-size:var(--fs-h2); font-weight:600; line-height:1.35; margin:1.4rem 0 .8rem; }
.blog-typo h3{ font-size:var(--fs-h3); font-weight:600; line-height:1.4; margin:1rem 0 .6rem; }
.blog-typo strong{ font-weight:600; }
.blog-typo blockquote{
  margin:1.1rem 0; padding:.75rem 1rem; color:var(--muted);
  background:var(--card); border-left:3px solid var(--border); border-radius:.5rem;
}
.blog-typo blockquote p{ margin:.4rem 0; }
.blog-typo hr{ border:0; border-top:1px solid var(--border); margin:1.2rem 0; opacity:.6; }
.blog-typo figure{ margin:1.2rem 0 1.4rem; }
.blog-typo figure figcaption{ color:var(--muted); font-size:.92rem; margin-top:.5rem; }
.blog-typo .viz iframe{ aspect-ratio:16/9; border-radius:.75rem; }
</style>
