---
import Layout from "../../../layouts/Layout.astro";
import Breadcrumbs from "../../../components/Breadcrumbs.astro";
import { dict, normalizeLang, languages } from "../../../i18n";
import { getCollection, type CollectionEntry } from "astro:content";

export const prerender = true;

/** 兼容三种 slug 形态：
 *  A) docs/<slug>/<lang>      →  slug 在前，语言在后
 *  B) docs/<lang>/<slug>      →  语言在前，slug 在后
 *  C) docs/<slug>             →  无语言，默认 en
 */
export async function getStaticPaths() {
  const all = await getCollection("docs");
  const langSet = new Set(languages);

  return all.map((entry: CollectionEntry<"docs">) => {
    const parts = entry.slug.split("/").filter(Boolean);

    let lang = "en";
    let slug = "";

    if (parts.length === 0) {
      slug = "";
    } else if (langSet.has(parts[0]!)) {
      // 语言在第一段：zh/foo/bar
      lang = parts[0]!;
      slug = parts.slice(1).join("/") || parts[1] || "";
    } else if (langSet.has(parts.at(-1)!)) {
      // 语言在最后一段：foo/bar/en
      lang = parts.at(-1)!;
      slug = parts.slice(0, -1).join("/") || parts[0] || "";
    } else {
      // 没有语言：默认 en；slug 为全部
      slug = parts.join("/");
    }

    return { params: { lang, slug }, props: { entry, lang, slug } };
  });
}

type PageParams = { lang: string; slug: string };
const { lang: rawLang, slug } = Astro.params as PageParams;

const paramsLang = normalizeLang(rawLang ?? "en");
const t = dict[paramsLang];
const base = paramsLang === "en" ? "/en" : `/${paramsLang}`;

const { entry } = Astro.props as { entry: CollectionEntry<"docs"> };
const { Content } = await entry.render();

const alternates = Object.fromEntries(
  languages.map((code) => [code, `${code === "en" ? "/en" : "/" + code}/docs/${slug}`]),
);

const tags = (entry?.data?.tags ?? []) as string[];
---

<Layout lang={paramsLang} title={`${entry.data.title} · Xiaosi Huang`} alternates={alternates}>
  <section class="mx-auto max-w-5xl px-4 md:px-6 py-10">
    <div class="post-header">
      <div class="crumb-row">
        <Breadcrumbs
          items={[
            { href: base, label: t.nav.home },
            { href: `${base}/docs`, label: t.nav.docs },
          ]}
        />
        <p class="backlink"><a href={`${base}/docs`}>← {t.ui.backToDocs}</a></p>
      </div>

      <div class="hero-head">
        {entry.data.kicker && <div class="post-kicker">{entry.data.kicker}</div>}
        <h1 class="post-title">{entry.data.title}</h1>

        {(entry.data.date || entry.data.subtitle) && (
          <div class="date-subtitle-row" role="group" aria-label="date and subtitle">
            {entry.data.date && (
              <time
                class="post-date"
                datetime={entry.data.date.toISOString?.() ?? String(entry.data.date)}
              >
                {new Date(entry.data.date).toLocaleDateString(paramsLang)}
              </time>
            )}
            {entry.data.subtitle && (
              <span class="post-subtitle-inline">{entry.data.subtitle}</span>
            )}
          </div>
        )}

        {tags.length > 0 && (
          <div class="tags">
            {tags.map((tag) => (
              <a class="tag" href={`${base}/docs?tag=${encodeURIComponent(String(tag))}`}>#{tag}</a>
            ))}
          </div>
        )}
        <hr class="hairline" />
      </div>
    </div>

    <article class="post-body blog-typo">
      <Content />
    </article>
  </section>
</Layout>

<style>
:root{
  --muted:#6b7280;
  --text:#111827;
  --border:#e5e7eb;
  --tag-bg:#f6f7f9;
}
@media (prefers-color-scheme: dark){
  :root{
    --muted:#9aa0a6;
    --text:#e5e7eb;
    --border:#1f2937;
    --tag-bg:#101418;
  }
}

/* 顶部容器与页面一致，居中 */
.post-header{ max-width:64rem; margin:0 auto; width:100%; }

/* 面包屑 + 返回 */
.crumb-row{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-bottom:.35rem; }
@media (max-width:640px){ .crumb-row{ flex-direction:column; align-items:flex-start; gap:.25rem; } }
.backlink{ font-size:.9rem; color:var(--muted); white-space:nowrap; }
.backlink a{ color:inherit; text-decoration:none; }
.backlink a:hover{ text-decoration:underline; }

/* 标题区：更小 + 更宽（与 Blog/Projects 对齐） */
.hero-head{ max-inline-size:110ch; margin:0; }
@media (min-width:1280px){ .hero-head{ max-inline-size:120ch; } }
@media (max-width:900px){ .hero-head{ max-inline-size:90ch; } }
@media (max-width:640px){ .hero-head{ max-inline-size:100%; } }

.post-title{
  margin:.4rem 0 .4rem;
  font-weight:800;
  font-size: clamp(1.2rem, 0.85rem + 0.95vw, 1.55rem);
  line-height:1.14;
  letter-spacing:-.012em;
  text-wrap:balance;
  color:var(--text);
}
.post-kicker{ color:var(--muted); font-size:.95rem; margin-bottom:.2rem; }

/* 日期 + 副标题同行 */
.date-subtitle-row{
  display:flex; align-items:center; gap:.5rem;
  white-space:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch;
  color:var(--muted); font-size:1rem; margin:.1rem 0 .7rem; padding-bottom:.15rem;
}
.date-subtitle-row::-webkit-scrollbar{ height:8px; }
.date-subtitle-row::-webkit-scrollbar-thumb{ background:var(--border); border-radius:9999px; }
.post-date{ font-weight:500; flex-shrink:0; }
.post-subtitle-inline{ font-weight:400; }

/* 标签 chip */
.tags{ display:flex; flex-wrap:wrap; gap:.35rem; margin:.2rem 0 .85rem; }
.tag{ font-size:.8rem; color:var(--muted); background:var(--tag-bg); border:1px solid var(--border); padding:.3rem .55rem; border-radius:.55rem; text-decoration:none; }
.tag:hover{ filter:brightness(1.03); }
.hairline{ border:0; border-top:1px solid color-mix(in srgb, var(--text) 12%, transparent); margin:.25rem 0 1.1rem; }

/* 正文排版 */
.blog-typo{ --fs-body:1rem; --fs-h2:1.12rem; --fs-h3:1.02rem; }
.blog-typo p{ font-size:var(--fs-body); line-height:1.85; margin:1rem 0; }
.blog-typo ul, .blog-typo ol{ margin:.9rem 0 .9rem 1.2rem; }
.blog-typo li{ margin:.35rem 0; }
.blog-typo h2{ font-size:var(--fs-h2); font-weight:600; line-height:1.35; margin:1.4rem 0 .8rem; }
.blog-typo h3{ font-size:var(--fs-h3); font-weight:600; line-height:1.4; margin:1rem 0 .6rem; }
.blog-typo strong{ font-weight:600; }
.blog-typo blockquote{ margin:1.1rem 0; padding:.75rem 1rem; color:var(--muted); background:var(--tag-bg); border-left:3px solid var(--border); border-radius:.5rem; }
.blog-typo hr{ border:0; border-top:1px solid var(--border); margin:1.2rem 0; opacity:.6; }
.blog-typo figure{ margin:1.2rem 0 1.4rem; }
.blog-typo figure figcaption{ color:var(--muted); font-size:.92rem; margin-top:.5rem; }
.blog-typo .viz iframe{ aspect-ratio:16/9; border-radius:.75rem; }
</style>
