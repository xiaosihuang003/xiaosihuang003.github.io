---
import Layout from "../../../layouts/Layout.astro";
import Breadcrumbs from "../../../components/Breadcrumbs.astro";
import { dict, normalizeLang, languages } from "../../../i18n";
import { getCollection, type CollectionEntry } from "astro:content";

export const prerender = true;

export async function getStaticPaths() {
  const all = await getCollection("blog");
  return all.map((entry: CollectionEntry<"blog">) => {
    const parts = entry.slug.split("/");
    // 语言放最后一段（如 .../en），没有就回退 en
    const lang = (parts.at(-1) ?? "en") as string;
    // 其余部分作为 slug
    const slug = parts.slice(0, -1).join("/") || parts[0];
    return { params: { lang, slug }, props: { entry, lang, slug } };
  });
}

// 明确这个路由的参数形状，避免 undefined 
type PageParams = { lang: string; slug: string };
const { lang: langParam, slug } = Astro.params as PageParams;

const paramsLang = normalizeLang(langParam ?? "en");
const t = dict[paramsLang];
const base = paramsLang === "en" ? "/en" : `/${paramsLang}`;

// entry 用博客集合的类型
const { entry } = Astro.props as { entry: CollectionEntry<"blog"> };

const alternates = Object.fromEntries(
  languages.map((code) => [code, `${code === "en" ? "/en" : "/" + code}/blog/${slug}`]),
);

const tags = (entry?.data?.tags ?? []) as string[];
const { Content } = await entry.render();
---

<Layout lang={paramsLang} title={`${entry.data.title} · Xiaosi Huang`} alternates={alternates}>
  <section class="mx-auto max-w-3xl px-4 md:px-6 py-10">
    <div class="post-header">
      <!-- 面包屑 + 返回 同一行 -->
      <div class="crumb-row">
        <Breadcrumbs
          items={[
            { href: base, label: t.nav.home },
            { href: `${base}/blog`, label: t.nav.blog },
            // 不再重复标题
          ]}
        />
        <p class="backlink"><a href={`${base}/blog`}>← {t.ui.backToBlog}</a></p>
      </div>

      {entry.data.kicker && <div class="post-kicker">{entry.data.kicker}</div>}
      <h1 class="post-title">{entry.data.title}</h1>
      {entry.data.subtitle && <p class="post-subtitle">{entry.data.subtitle}</p>}

      <div class="post-meta">
        {entry.data.date && (
          <time datetime={entry.data.date.toISOString?.() ?? String(entry.data.date)}>
            {new Date(entry.data.date).toLocaleDateString(paramsLang)}
          </time>
        )}
        {tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {tags.map((tag) => <span class="tag">#{tag}</span>)}
          </div>
        )}
      </div>
    </div>

    <article class="post-body blog-typo">
      <Content />
    </article>
  </section>
</Layout>

<style>
/* 面包屑 + 返回 同行：右侧对齐 */
.crumb-row{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: .75rem;
  margin-bottom: .35rem;
}
@media (max-width: 640px){
  .crumb-row{
    flex-direction: column;
    align-items: flex-start;
    gap: .25rem;
  }
}

.backlink{
  font-size: .9rem;
  color: var(--muted);
  white-space: nowrap;
}
.backlink a{ text-decoration: none; color: inherit; }
.backlink a:hover{ text-decoration: underline; }

/* 仅博客详情页的排版微调：更克制的小标题、段落与引文 */
.blog-typo{
  --fs-body: 1rem;
  --fs-h2: 1.12rem;
  --fs-h3: 1.02rem;
}
.blog-typo p{ font-size: var(--fs-body); line-height: 1.85; margin: 1rem 0; }
.blog-typo ul, .blog-typo ol{ margin: .9rem 0 .9rem 1.2rem; }
.blog-typo li{ margin: .35rem 0; }

.blog-typo h2{ font-size: var(--fs-h2); font-weight: 600; line-height: 1.35; margin: 1.4rem 0 .8rem; }
.blog-typo h3{ font-size: var(--fs-h3); font-weight: 600; line-height: 1.4;  margin: 1rem 0 .6rem; }

.blog-typo strong{ font-weight: 600; }

.blog-typo blockquote{
  margin: 1.1rem 0;
  padding: .75rem 1rem;
  background: var(--card);
  border-left: 3px solid var(--border);
  border-radius: .5rem;
  color: var(--muted);
}
.blog-typo blockquote p{ margin: .4rem 0; }

.blog-typo hr{ border:0; border-top:1px solid var(--border); margin: 1.2rem 0; opacity:.6; }
.blog-typo figure{ margin: 1.2rem 0 1.4rem; }
.blog-typo figure figcaption{ color: var(--muted); font-size: .92rem; margin-top: .5rem; }

.blog-typo .viz iframe{ aspect-ratio: 16/9; border-radius: .75rem; }
</style>
