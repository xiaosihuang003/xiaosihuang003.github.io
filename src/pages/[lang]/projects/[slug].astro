---
// src/pages/[lang]/projects/[slug].astro
import Layout from "../../../layouts/Layout.astro";
import { dict, normalizeLang } from "../../../i18n";
import { getCollection } from "astro:content";
import BackButton from "../../../components/BackButton.astro";
import Breadcrumbs from "../../../components/Breadcrumbs.astro";

export const prerender = true;

// ✅ 生成所有 (lang, slug) 路径
export async function getStaticPaths() {
  const items = await getCollection("projects");
  return items.map((p) => ({
    params: { lang: p.data.lang, slug: p.slug },
  }));
}

const lang = normalizeLang(Astro.params.lang as string);
const t = dict[lang];
const base = lang === "en" ? "/en" : `/${lang}`;
const slug = Astro.params.slug as string;

const entry = (await getCollection("projects")).find(
  (x) => x.slug === slug && x.data.lang === lang
);
if (!entry) throw new Error(`Project not found: ${slug} (${lang})`);

const data = entry.data;
const Content = await entry.render();
---

<Layout lang={lang} title={data.title}>
  <section class="mx-auto max-w-3xl px-4 md:px-6 lg:px-0 pt-6 md:pt-8">
    <div class="flex items-center justify-between gap-3 flex-wrap mb-4">
      <Breadcrumbs
        items={[
          { href: `${base}/`, label: t.ui.breadcrumbs.home },
          { href: `${base}/projects`, label: t.nav.projects },
          { label: data.title },
        ]}
      />
      <BackButton href={`${base}/projects`} kind="projects" lang={lang} />
    </div>

    <header class="mb-6">
      <h1 class="post-title">{data.title}</h1>
      {data.excerpt && <p class="post-subtitle">{data.excerpt}</p>}
      <div class="post-meta">
        <time datetime={data.date.toISOString()}>{data.date.toLocaleDateString(lang)}</time>
        {data.tags?.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {data.tags.map((tag) => <span class="tag">#{tag}</span>)}
          </div>
        )}
      </div>
    </header>

    <article class="post-body">
      <Content.Content />
    </article>
  </section>
</Layout>
